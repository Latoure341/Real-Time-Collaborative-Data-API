<!DOCTYPE html>
<html>
<head>
    <title>Collaborative Editor - Presence Example</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        .client-list {
            list-style: none;
            padding: 0;
        }
        .client-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background: #f0f0f0;
            border-left: 4px solid;
        }
        .client-item.active {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .client-item.inactive {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-active {
            background: #4caf50;
            color: white;
        }
        .status-inactive {
            background: #ff9800;
            color: white;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #1976D2;
        }
        .stats {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .cursor-info {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Real-Time Collaborative Editor - Presence Demo</h1>
    
    <div class="container">
        <!-- Left Panel: Your Client Info -->
        <div class="panel">
            <h2>Your Client</h2>
            <div class="stats">
                <strong>ID:</strong> <code id="myId">Connecting...</code><br>
                <strong>Room:</strong> <code id="myRoom">-</code><br>
                <strong>Status:</strong> <span id="myStatus" class="status-badge status-inactive">Idle</span>
            </div>
            
            <h3>Cursor Position</h3>
            <textarea id="editor" placeholder="Start typing to share cursor position..."></textarea>
            
            <h3>Actions</h3>
            <button onclick="joinRoom()">Join Room</button>
            <button onclick="toggleActivity()">Toggle Activity</button>
            <button onclick="leaveRoom()">Leave Room</button>
            <button onclick="sendMessage()">Send Message</button>
        </div>

        <!-- Right Panel: Room Presence -->
        <div class="panel">
            <h2>Room Presence</h2>
            <div class="stats" id="roomStats">
                <strong>Active Clients:</strong> <span id="activeCount">0</span><br>
                <strong>Total in Room:</strong> <span id="totalCount">0</span>
            </div>
            
            <h3>Connected Clients</h3>
            <ul class="client-list" id="clientList">
                <li class="client-item">Waiting for connections...</li>
            </ul>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:3000', {
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });

        const roomName = 'demo-room';
        let currentRoom = null;
        let isActive = false;

        // Set client ID
        socket.on('connect', () => {
            document.getElementById('myId').textContent = socket.id;
            console.log('Connected:', socket.id);
        });

        // Join room
        function joinRoom() {
            socket.emit('join', {
                room: roomName,
                clientInfo: { name: 'User ' + socket.id.slice(0, 5) }
            });
            currentRoom = roomName;
            document.getElementById('myRoom').textContent = roomName;
        }

        // Leave room
        function leaveRoom() {
            socket.emit('leave', { room: roomName });
            currentRoom = null;
            document.getElementById('myRoom').textContent = '-';
        }

        // Toggle activity
        function toggleActivity() {
            isActive = !isActive;
            socket.emit('activity-status', {
                room: roomName,
                isActive: isActive
            });
            document.getElementById('myStatus').textContent = isActive ? 'Active' : 'Idle';
            document.getElementById('myStatus').className = isActive ? 'status-badge status-active' : 'status-badge status-inactive';
        }

        // Track cursor movement
        document.getElementById('editor').addEventListener('keyup', (e) => {
            const textarea = e.target;
            const cursorPos = textarea.selectionStart;
            const line = textarea.value.substring(0, cursorPos).split('\n').length;
            const col = cursorPos - textarea.value.substring(0, cursorPos).lastIndexOf('\n');

            socket.emit('cursor-move', {
                room: roomName,
                cursor: { line, col, char: cursorPos }
            });
        });

        // Listen for presence initialization
        socket.on('presence-init', (presence) => {
            console.log('Room presence initialized:', presence);
            updatePresenceUI(presence);
        });

        // Listen for client joined
        socket.on('client-joined', (clientState) => {
            console.log('Client joined:', clientState);
            requestPresenceUpdate();
        });

        // Listen for client left
        socket.on('client-left', (data) => {
            console.log('Client left:', data);
            requestPresenceUpdate();
        });

        // Listen for cursor move
        socket.on('cursor-move', (data) => {
            console.log('Cursor move from', data.clientId, ':', data.cursor);
            // Update UI to show remote cursor
        });

        // Listen for activity status changes
        socket.on('activity-status', (data) => {
            console.log('Activity status from', data.clientId, ':', data.isActive);
            requestPresenceUpdate();
        });

        // Request presence update
        function requestPresenceUpdate() {
            socket.emit('get-presence', roomName);
        }

        // Listen for presence data
        socket.on('presence-data', (presence) => {
            updatePresenceUI(presence);
        });

        // Update presence UI
        function updatePresenceUI(presence) {
            const activeCount = presence.clients.filter(c => c.isActive).length;
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('totalCount').textContent = presence.count;

            const clientList = document.getElementById('clientList');
            clientList.innerHTML = '';

            presence.clients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'client-item ' + (client.isActive ? 'active' : 'inactive');
                
                const colorDot = `<span class="color-dot" style="background: ${client.color}"></span>`;
                const status = client.isActive ? 'ðŸŸ¢ Active' : 'âšª Idle';
                const cursor = client.cursor ? ` (Line ${client.cursor.line}, Col ${client.cursor.col})` : '';
                
                li.innerHTML = `${colorDot}<strong>${client.name}</strong> ${status}${cursor}`;
                clientList.appendChild(li);
            });
        }

        // Send message
        function sendMessage() {
            const msg = prompt('Enter message:');
            if (msg) {
                socket.emit('message', {
                    room: roomName,
                    message: msg
                });
            }
        }

        // Listen for messages
        socket.on('message', (data) => {
            console.log('Message from', data.from, ':', data.message);
            alert(`Message: ${data.message}`);
        });

        // Auto-join on load
        setTimeout(() => joinRoom(), 500);

        // Periodically request presence update
        setInterval(() => {
            if (currentRoom) {
                requestPresenceUpdate();
            }
        }, 2000);
    </script>
</body>
</html>
